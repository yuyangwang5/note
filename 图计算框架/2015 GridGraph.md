# GridGraph: Large-Scale Graph Processing on a Single Machine Using 2-Level Hierarchical Partitioning

## Graph Representation: The Grid Form

GridGraph将顶点划分为P个均匀的顶点块，每个块包含范围连续的顶点，整个PxP块可以视作一个网格。每条边根据以下规则放入对应的块：src决定行、dst决定列，如下图所示：

![grid form](./pic/2015%20GridGraph/00%20grid%20form.png "grid form")

除了边块，GridGraph还创建了包含全局信息的元数据文件，包括顶点数 V、边数 E、分区数 P、边类型 T（指示是否加权）。每个边块会对应为磁盘上的一个文件。

GridGraph的预处理过程如下：
1. 主线程从边列表中顺序读取边，将其分成若干批次，将每批边推送到任务队列中（为了实现较大的顺序磁盘带宽，每个批次边的大小为24MB）。
2. 每个工作线程从队列中获取一个任务（一个批次），计算该批次中每条边所属的块。每个工作线程为每个块维护一个本地缓冲区，缓冲区满时将缓冲区的边追加到文件中。

现实中图不规则，由此可能一些边块太小，无法在HDD（硬盘驱动器，Hard Disk Drive，传统硬盘）上实现足够的顺序带宽。为了避免这种性能损失，GridGraph会在HDD系统上执行额外的合并阶段，将边块文件注意追加到大文件中，并在元数据中记录每个块的起始偏移量。

由于不需要排序，相比于GraphChi，GridGraph更快。

GridGraph完成预处理的时间短，只需要一次读写操作，且通过分区，GridGraph可以执行选择性调度，减少对没有活跃边的边块访问。

P的选择，更大的P（更细粒度）虽然增加了预处理时间，但能够实现更好的顶点数据访问局部性，也能更好地进行选择性调度。由此，较大的P是更有选择。GridGraph选择P的方式是，使得顶点数据能够放入最后一级缓存：

$$\frac{VU}{C}\le C$$

其中C是最后一级缓存大小，U是每个顶点数据大小，V是顶点数，P会取满足该式子的最小整数。

## 流式应用处理模型 The Streaming-Apply Processing Model

### 双窗口滑动

GridGraph通过块来流式传输边集。每个块足够小，可以适应快速存储（内存于外存，最高级缓存于内存），以保证访问具有良好的局部性。

块的访问顺序可以是行导向，也可以是列导向的。为了减少昂贵的磁盘写操作，且列对应于目标顶点块，所以更倾向于列导向的访问。特别是对于SSD，写放大现象会在写入大量数据后降低写性能，且SSD的写入周期有上限，尽可能减少磁盘写入可以延长SSD的使用寿命。

![dual sliding windows](./pic/2015%20GridGraph/01%20dual%20sliding%20windows.png "dual sliding windows")

以pagerank为例，如上图所示，进行列导向计算时，读取窗口（左侧窗口）会读取出度信息和上一轮迭代后的pagerank值，写入窗口（上面窗口）会累积新的pagerank值。我们会在内存中将节点的新值累加完，再将新值写回。在累加过程中存在数据竞争，因此累加操作需要为原子操作。

对边只进行只读访问，GridGraph只需要一个小缓冲区来保持正在流式传输的边数据。该流式模型不仅支持BSP，还允许异步更新。

### 二级层次分区

在进行列导向访问时，边被访问1次，源顶点数据被读取了P次，目标定点数据被读取、写入一次。由此可得每次迭代的I/O量为：

$$E + P \times V + 2\times V$$

由此看，P越小，I/O量越小。这与之前讨论较大P有更好局部性和选择调度效果相冲突。

为了解决该问题，在原有网格的基础上，我们引入了二级分区。更高级的分区为 Q x Q网格。其大小确定条件是，给定一定量内存M，每个顶点数据U大小，Q为满足不等式条件的最小整数：$\frac{V}{Q} * U \le M$。因为P希望的是顶点数据适应最后一级缓存，由此P远大于Q，二级层次分区的粒度更粗。我们会在二级层次分区中使用列导向访问，而在粗粒度大块中，我们也会对其中的小块进行列导向访问。

在实验中，Q越小，执行时间越快。

### 执行实现
流式传输前，GridGraph会先检查每个顶点块的活跃性，然后按双滑动窗口的顺序一个接着一个进行流式传输。步骤如下：
1. 主线程将任务推送到队列，保活文件、偏移和长度（长度设为24MB，与预处理一样，以实现全磁盘带宽）。
2. 工作线程从队列取任务，直到队列为空。然后读取数据，处理每一条边。










